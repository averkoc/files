<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Relay Control</title>
  <style>
    body {
      text-align: center;
    }
    h2 {
      text-align: center;
    }
    .accordion-container {
      width: 50%;
      margin: 0 auto;
      box-sizing: border-box;
      text-align: left;
    }
    /* Accordion Header Styles */
    .accordion {
      cursor: pointer;
      padding: 10px;
      background-color: #f1f1f1;
      border: 1px solid #ccc;
      border-radius: 5px;
      text-align: center;
      outline: none;
      font-size: 15px;
      transition: 0.4s;
      width: 100%;
      box-sizing: border-box;
    }
    .accordion.active {
      background-color: #ccc;
    }
    /* Panel (content) initially shown */
    .panel {
      display: block;
      text-align: center;
    }
    .button-group {
      padding: 10px;
    }
    .button {
      padding: 10px;
      margin: 5px;
      cursor: pointer;
      width: 45%;
      display: inline-block;
    }
    /* Default state “off” */
    .button.off {
      background-color: green;
      color: white;
    }
    /* When pressed, state “on” */
    .button.on {
      background-color: red;
      color: white;
    }
    .status-line {
      margin-top: 20px;
      font-weight: bold;
    }
    @media (max-width: 600px) {
      .accordion-container {
        width: 90%;
      }
      .button {
        width: 45%;
      }
    }
  </style>
</head>
<body>
  <h2>Relay Control</h2>
  <div class="accordion-container">

    <!-- Relay Module Group 1 -->
    <div class="accordion">Group 1</div>
    <div class="panel">
      <div class="button-group" id="1">
        <button class="button off" data-relay="1">Relay 1</button>
        <button class="button off" data-relay="2">Relay 2</button>
        <button class="button off" data-relay="3">Relay 3</button>
        <button class="button off" data-relay="4">Relay 4</button>
        <button class="button off" data-relay="5">Relay 5</button>
        <button class="button off" data-relay="6">Relay 6</button>
        <button class="button off" data-relay="7">Relay 7</button>
        <button class="button off" data-relay="8">Relay 8</button>
      </div>
    </div>

    <!-- Relay Module Group 2 -->
    <div class="accordion">Group 2</div>
    <div class="panel">
      <div class="button-group" id="2">
        <button class="button off" data-relay="1">Relay 1</button>
        <button class="button off" data-relay="2">Relay 2</button>
        <button class="button off" data-relay="3">Relay 3</button>
        <button class="button off" data-relay="4">Relay 4</button>
        <button class="button off" data-relay="5">Relay 5</button>
        <button class="button off" data-relay="6">Relay 6</button>
        <button class="button off" data-relay="7">Relay 7</button>
        <button class="button off" data-relay="8">Relay 8</button>
      </div>
    </div>

  </div>

  <div class="status-line" id="status-line">
    Connection status: <span id="connection-status">Disconnected</span>
  </div>

  <script>
    var ws;
    var reconnectInterval = 5000; // milliseconds
    var activeButton = null; // currently pressed button

    // Establish the WebSocket connection
    function connectWebSocket() {
      ws = new WebSocket('ws://' + window.location.hostname + '/ws');
      
      ws.onopen = function() {
        logMessage('WebSocket connection opened');
        updateStatus('Connected');
      };

      ws.onclose = function() {
        logMessage('WebSocket connection closed');
        updateStatus('Disconnected');
        setTimeout(connectWebSocket, reconnectInterval);
      };

      ws.onmessage = function(event) {
        logMessage('WebSocket message received: ' + event.data);
      };

      ws.onerror = function(error) {
        logMessage('WebSocket error: ' + error);
        updateStatus('Error');
      };
    }

    // Helper: log messages
    function logMessage(message) {
      console.log(message);
    }

    // Helper: update connection status on the page
    function updateStatus(status) {
      document.getElementById('connection-status').innerText = status;
    }

    // Send a command using the module id, relay number, and state (true for on, false for off)
    function sendCommand(module, relay, state) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        var command = module + ':' + relay + ':' + (state ? '1' : '0');
        ws.send(command);
        logMessage('Sent command: ' + command);
      } else {
        logMessage('WebSocket is not connected. Cannot send command.');
      }
    }

    // Button press event handler
    function handleButtonPress(event) {
      // Allow only one active button at a time.
      if (activeButton !== null) return;

      event.preventDefault();
      activeButton = this;
      this.classList.remove('off');
      this.classList.add('on');

      var relayModule = this.closest('.button-group');
      var moduleId = relayModule ? relayModule.id : null;
      var relayNumber = this.getAttribute('data-relay');
      sendCommand(moduleId, relayNumber, true);
    }

    // Button release event handler
    function handleButtonRelease(event) {
      if (activeButton !== this) return; // Only process if this button is currently active

      event.preventDefault();
      this.classList.remove('on');
      this.classList.add('off');

      var relayModule = this.closest('.button-group');
      var moduleId = relayModule ? relayModule.id : null;
      var relayNumber = this.getAttribute('data-relay');
      sendCommand(moduleId, relayNumber, false);
      activeButton = null;
    }

    // Attach press & release events to a button element
    function addEventListeners(button) {
      button.addEventListener('mousedown', handleButtonPress);
      button.addEventListener('touchstart', handleButtonPress);
      button.addEventListener('mouseup', handleButtonRelease);
      button.addEventListener('touchend', handleButtonRelease);
      button.addEventListener('mouseleave', handleButtonRelease);
      button.addEventListener('touchcancel', handleButtonRelease);
    }

    // Initialize event listeners for all buttons
    document.querySelectorAll('.button').forEach(addEventListeners);

    // Accordion functionality for toggling relay module panels.
    // Use pointer events if supported to avoid duplicate events on mobile.
    var accordionEvent = window.PointerEvent ? "pointerdown" : "click";
    var acc = document.getElementsByClassName("accordion");
    for (var i = 0; i < acc.length; i++) {
      acc[i].addEventListener(accordionEvent, function(e) {
        e.preventDefault();
        this.classList.toggle("active");
        var panel = this.nextElementSibling;
        // Use computed style to check the actual current display state
        var currentDisplay = window.getComputedStyle(panel, null).getPropertyValue("display");
        panel.style.display = (currentDisplay === "block" ? "none" : "block");
      });
    }

    // Initialize the WebSocket connection
    connectWebSocket();
  </script>
</body>
</html>
